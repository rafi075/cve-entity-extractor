import json
from pathlib import Path
from datasets import load_dataset
import json
import uuid

annotation_file_path = Path("label-studio-cve-annotations.json")

label_to_question = {
    "Vendor": "Who is the vendor involved?",
    "Software": "What software is vulnerable?",
    "Software Version": "Which versions of the software are affected?",
    "Operating System": "Which operating system is mentioned?",
    "Source": "What is the source component of the vulnerability?",
    "Trigger": "What action or condition triggers the vulnerability?",
    "Reason": "Why does the vulnerability exist?",
    "System State": "What system state allows for the vulnerability to be exploited?",
    "Consequences": "What are the potential consequences of the vulnerability?",
    "Vulnerability Type": "How is the vulnerability classified?",
    "Attacker Action": "What must an attacker do to exploit the vulnerability?",
    "Network Access": "What type of network access does an attacker need?",
    "Privilege": "What level of privilege is required for the attack?",
    "User Interaction": "Does the exploit require user interaction?",
    "Exploit": "Is there a public exploit available for the vulnerability?",
    "Patch": "Has a patch been issued for the vulnerability?",
}


def generate_hex_uuid():
    id = uuid.uuid4()
    return id.hex


class CVE:
    def __init__(self, cve_entry):
        for k, v in cve_entry.items():
            if k.lower().startswith("cvss"):
                field = "cvss_v3_score"
            else:
                field = "_".join(k.lower().split())

            setattr(self, field, v)


with open(annotation_file_path, "rb") as annotation_file:
    annotations_entries = json.load(annotation_file)

    combined_annotation = []

    for annotation_entry in annotations_entries:
        annotation_data = annotation_entry["data"]

        cve = CVE(annotation_data)

        # there could be multiple annotations for the same entry
        annotations = annotation_entry["annotations"][0]["result"]

        for annotation in annotations:
            text = annotation["value"]["text"]
            start = annotation["value"]["start"]
            end = annotation["value"]["end"]
            label = annotation["value"]["labels"][0]
            question = label_to_question[label]

            qa_entry = {}

            qa_entry["id"] = generate_hex_uuid()
            qa_entry["context"] = cve.description
            qa_entry["question"] = question
            qa_entry["answers"] = {
                "text": [text],
                "answer_start": [start],
                # "answer_end": [end],
            }

            combined_annotation.append(qa_entry)

with open("annotations_dataset.json", "w") as f:
    json.dump(combined_annotation, f, indent=4)
