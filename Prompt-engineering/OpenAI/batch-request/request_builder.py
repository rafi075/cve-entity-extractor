import pandas as pd
import json
import copy




request_format = {	
		"custom_id":"CVE-2023-50094",
		"method":"POST",
		"url":"/v1/chat/completions",
		"body":{
			"model":"gpt-4o-2024-08-06",
			"messages":[
				{	
					"role":"system",
					"content":"You are an expert at structured entity extraction from security vulnerability description. You will be given an unstructured text from a secuirty vulnerability description and should convert it into the given structure of json schema. Here is the definition of the entities to form the structure, vendor: Who is the vendor involved?, software: What software is vulnerable?,software_version: Which versions of the software are affected?,operating_system: Which operating system is mentioned?,source: What is the source component of the vulnerability?,trigger: What action or condition triggers the vulnerability?,reason: Why does the vulnerability exist?,system_state: What system state allows for the vulnerability to be exploited?,consequences: What are the potential consequences of the vulnerability?,vulnerability_type: How is the vulnerability classified or typed?,attacker_action: What must an attacker do to exploit the vulnerability?,network_access: What type of network access does an attacker need?,privilege: What level of authentication privilege is required for the attack?,user_interaction: Does the exploit require user interaction?"
				},
				{
					"role":"user",
					"content":"Recognize entities from the following vulnerability description, Description: The affiliate- toolkit WordPress plugin before 3.4.3 lacks authorization and authentication for requests to it's affiliate-toolkit-starter/tools/atkp_imagereceiver.php endpoint, allowing unauthenticated visitors to make requests to arbitrary URL's, including RFC1918 private addresses, leading to a Server Side Request Forgery (SSRF) issue."
				},
				{
					"role":"assistant",
					"content":"{'vendor':'WordPress','software':'affiliate-toolkit plugin','software_version':'before 3.4.3','operatig_system':'N/A','source':'affiliate-toolkit-starter/tools/atkp_imagereceiver.php endpoint','reason':'lacks authorization and authentication for requests','trigger':'requests to arbitrary URL's, including RFC1918 private addresses','attacker_action':'make requests to arbitrary URL's','user_interaction':'No','system_state':'','network_access':'Remote','privilege':'Unauthenticated','vulnerability_type':'Server Side Request Forgery (SSRF)','consequences':'Potential unauthorized server requests to internal network addresses'}"
	        	},
	        	{
					"role":"user",
					"content":"Recognize entities from the following vulnerability description, Description: The affiliate- toolkit WordPress plugin before 3.4.3 lacks authorization and authentication for requests to it's affiliate-toolkit-starter/tools/atkp_imagereceiver.php endpoint, allowing unauthenticated visitors to make requests to arbitrary URL's, including RFC1918 private addresses, leading to a Server Side Request Forgery (SSRF) issue."
				}
			],
			"response_format":{

				"type":"json_schema",
				"json_schema":{
					"name":"vulnerabilitiy_entity_extraction_response",
					"schema":{
						"type":"object",
						"properties":{

							"vendor":{"type":"string","description":"Vendor involved with the vulnerable software"},
							"software":{"type":"string","description":"Name of the software that is vulnerable "},
							"software_version":{"type":"string","description":"The versions of the software that contains the vulnerability"},
							"operatig_system":{"type":"string","description":"Operating system on which the vulnerability is active"},
							"source":{"type":"string","description":"The  buggy componenet or the  faulty functionality or the source of vulnerability"},
							"reason":{"type":"string","description":"The reason why the source of the vulnerability exists"},
							"trigger":{"type":"string","description":"The triggering action or condition that exploits the vulnerability"},
							"attacker_action":{"type":"string","description":"Actions attackers must execute to exploit the vulnerability"},
							"user_interaction":{"type":"string","description":"If any user or victim's action is required, specify"},
							"system_state":{"type":"string","description":"Any system specific requirements or configuration or condition that are needed for the exploitation"},
							"network_access":{"type":"string","description":"Type of network access the attacker needs"},
							"privilege":{"type":"string","description":"Level of authentication previlege the attacker needs"},
							"vulnerability_type":{"type":"string","description":"Type of vulnerability"},
							"consequences":{"type":"string","description":"Result or consequence of the exploitation of the vulnerability"}
						},
						"required":["vendor","software","software_version","source","reason","trigger","attacker_action","user_interaction","system_state","network_access","privilege","vulnerability_type","consequences","operatig_system"],
					"additionalProperties":False
					},
				"strict":True
				}
			}
		}
	}
batch_requests = []
user_content_template ="Recognize entities from the following vulnerability description, Description: "

def add_to_batch_requests(row):
	#print(row['ID'])
	new_request = copy.deepcopy(request_format)
	
	
	new_request['body']['messages'][3]['content']=user_content_template+row['Description']
	new_request['custom_id']=row['ID']
	batch_requests.append(new_request)


df = pd.read_csv("cve-descriptions.csv")	
df.apply(add_to_batch_requests,axis =1)


with open('batch_request_one_shot_200.jsonl','w') as outfile:
	for entry in batch_requests:

		json.dump(entry,outfile)
		outfile.write('\n')

