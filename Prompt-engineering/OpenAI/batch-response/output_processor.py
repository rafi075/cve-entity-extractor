import json
import pandas as pd
output_file_path ="batch_66f50b244a608190a8904f08a4c1b7b4_output.jsonl"
raw_data_path="cve-descriptions.csv"

cve_records = pd.DataFrame()
extraction_response_list = []

#reading raw cve records and trasnfering them to a dataframe : cve_records
with open(raw_data_path,'r') as cve_data:
    cve_records = pd.read_csv(raw_data_path)
    cve_data.close()

#reading open AI batch output jsonl file and trasnfering the NER responses to a dataframe : cve_attributes 
with open(output_file_path, 'r') as json_file:
    json_list = list(json_file)

for json_str in json_list:
    result = json.loads(json_str)
    cve_id = result['custom_id']
    extraction_response = result['response']['body']['choices'][0]['message']['content']
    extraction_response = json.loads(extraction_response);
    new_extraction_response = extraction_response.copy()
    new_extraction_response['ID'] = result['custom_id']
    extraction_response_list.append(new_extraction_response)
    

cve_attributes = pd.DataFrame(extraction_response_list)
# Merge df1 with df2 based on the 'ID' column
merged_df = pd.merge(cve_records, cve_attributes, on='ID', how='left') 

# output to a csv file
merged_df.to_csv('merged_cve_dataset.csv', index=False)

    


    
  